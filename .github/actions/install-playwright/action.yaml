name: Install Playwright
description: Install Playwright and dependencies with cache

# https://github.com/microsoft/playwright/issues/7249

inputs:
  working-directory:
    description: Where to install Playwright
    default: ./

outputs:
  version:
    description: Installed version of Playwright
    value: ${{ steps.version.outputs.version }}
  cache-hit:
    description: Whether cache for Playwright was found
    value: ${{ steps.cache.outputs.cache-hit }}

runs:
  using: composite
  steps:
    - name: Get Playwright version
      uses: actions/github-script@v7
      id: version
      script: |
        import { createRequire } from "module";
        const require = createRequire(import.meta.url);
        const packageName = "@playwright/test";
        let version = "";
        const workingDirectory = core.getInput("working-directory");
        if (workingDirectory) process.chdir();
        console.debug("Working directory:", process.cwd());
        try {
          version = require(`${packageName}/package.json`).version;
        } catch (error) {
          console.log(error);
        }
        console.debug("Version:", version);
        if (version) {
          core.exportVariable("PLAYWRIGHT_VERSION", version);
          core.setOutput("version", version);
        } else core.setFailed("Couldn't get Playwright version");

    - name: Cache Playwright
      id: cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: playwright-${{ env.PLAYWRIGHT_VERSION }}

    - name: Install Playwright and its dependencies
      shell: bash
      if: steps.cache.outputs.cache-hit != 'true'
      working-directory: ${{ inputs.working-directory }}
      run: npx playwright install chromium --with-deps

    - name: Install just Playwright's dependencies
      shell: bash
      if: steps.cache.outputs.cache-hit == 'true'
      working-directory: ${{ inputs.working-directory }}
      run: npx playwright install-deps
